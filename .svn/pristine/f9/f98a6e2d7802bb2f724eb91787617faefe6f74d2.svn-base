<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="MapperArticulos">
  
    <resultMap id="resultMapArticulo" type="model.Articulo">        
        <result property="articuloId" column="id_articulo"/>
        <result property="categoriaId" column="categoriaId"/>
        <result property="usuarioId" column="id_usuario"/>
        <!-- color -->
        <result property="color.colorId" column="id_color"/>
        <result property="color.color" column="color"/> 
        <result property="color.tono" column="tono"/> 
        <result property="color.comentario" column="comentario"/>      
        
        <result property="cantidad" column="cantidad"/>        
        <result property="descripcion" column="descripcion"/>
        <result property="fechaIngreso" column="fecha_ingreso"/>
        <result property="precioCompra" column="precio_compra"/>
        <result property="precioRenta" column="precio_renta"/>        
        <result property="activo" column="activo"/>
        <result property="stock" column="stock"/>
        <result property="codigo" column="codigo"/>        
        <result property="enRenta" column="en_renta"/>
        <!-- categoria -->
        <result property="categoria.categoriaId" column="id_categoria"/>        
        <result property="categoria.descripcion" column="descripcion_categoria"/>    
        <result property="fechaUltimaModificacion" column="fecha_ultima_modificacion"/>

    </resultMap>
    
     <resultMap id="resultMapCategoria" type="model.CategoriaDTO">        
        <result property="categoriaId" column="id_categoria"/>
        <result property="descripcion" column="descripcion"/> 
    </resultMap>
    
     <resultMap id="resultMapColor" type="model.Color">        
        <result property="colorId" column="id_color"/>
        <result property="color" column="color"/> 
         <result property="tono" column="tono"/>
        <result property="comentario" column="comentario"/> 
    </resultMap>
    
    <select id="obtenerArticuloPorId" resultMap="resultMapArticulo" parameterType="java.lang.Integer">
        SELECT articulo.*, 
        categoria.descripcion AS descripcion_categoria, 
        color.color, color.tono, color.comentario       
        FROM articulo articulo
        INNER JOIN categoria categoria ON (categoria.id_categoria = articulo.id_categoria)
        INNER JOIN color color ON (color.id_color = articulo.id_color )
        WHERE articulo.activo = 1   
        AND articulo.id_articulo = #{id}     
    </select> 
  
    <select id="obtenerArticulosBusquedaInventario" resultMap="resultMapArticulo" parameterType="java.util.Map">
        SELECT articulo.*, 
        categoria.descripcion AS descripcion_categoria, 
        color.color        
        FROM articulo articulo
        INNER JOIN categoria categoria ON (categoria.id_categoria = articulo.id_categoria)
        INNER JOIN color color ON (color.id_color = articulo.id_color )
        WHERE articulo.activo = 1
        <if test="categoria != null ">
            AND categoria.descripcion LIKE CONCAT('%',#{categoria},'%')
        </if>
        <if test="color != null ">
            AND color.color LIKE CONCAT('%',#{color},'%')
        </if>
        <if test="descripcion != null ">
            AND articulo.descripcion LIKE CONCAT('%',#{descripcion},'%')
        </if>
    </select>  
    
    <select id="obtenerEnRenta" parameterType="java.util.Map" resultType="java.lang.String">
        SELECT SUM(detalle.cantidad)AS cantidad
        FROM renta renta
        INNER JOIN detalle_renta detalle ON (detalle.id_renta = renta.id_renta)
        WHERE detalle.id_articulo = #{articuloId}
        AND renta.id_estado = #{estado_renta}
        AND renta.id_tipo = #{tipo_pedido}
    </select>
    
    <select id="obtenerFaltantes" parameterType="java.util.Map" resultType="java.lang.String">
        SELECT SUM(faltante.cantidad)AS cantidad
        FROM faltantes faltante    
        WHERE faltante.id_articulo = #{articuloId} 
        AND faltante.fg_faltante = '1'
        AND faltante.fg_devolucion = '0'
        AND faltante.fg_accidente_trabajo = '0'
        AND faltante.fg_activo = '1'
    </select>
    
    <select id="obtenerReparacion" parameterType="java.util.Map" resultType="java.lang.String">
        SELECT SUM(faltante.cantidad)AS cantidad
        FROM faltantes faltante              
        WHERE faltante.id_articulo = #{articuloId}  
        AND faltante.fg_faltante = '0'
        AND faltante.fg_devolucion = '0'
        AND faltante.fg_accidente_trabajo = '0'
        AND faltante.fg_activo = '1'
    </select>
    
    <select id="obtenerAccidenteTrabajo" parameterType="java.util.Map" resultType="java.lang.String">
        SELECT SUM(faltante.cantidad)AS cantidad
        FROM faltantes faltante              
        WHERE faltante.id_articulo = #{articuloId}   
        AND faltante.fg_faltante = '0'
        AND faltante.fg_devolucion = '0'
        AND faltante.fg_accidente_trabajo = '1'
        AND faltante.fg_activo = '1'
    </select>
    
     <select id="obtenerDevolucion" parameterType="java.util.Map" resultType="java.lang.String">
        SELECT SUM(faltante.cantidad)AS cantidad
        FROM faltantes faltante         
        WHERE faltante.id_articulo = #{articuloId}
        AND faltante.fg_devolucion = '1'
        AND faltante.fg_faltante = '0'
        AND faltante.fg_activo = '1'
    </select>
    
    <select id="obtenerCategoriaPorDescripcion" parameterType="java.lang.String" resultMap="resultMapCategoria">
        SELECT * 
        FROM categoria 
        WHERE descripcion = #{descripcion}        
    </select>
    
    <select id="obtenerColorPorDescripcion" parameterType="java.lang.String" resultMap="resultMapColor">
        SELECT * 
        FROM color 
        WHERE color = #{descripcion}        
    </select>
    <insert id="insertarArticulo" parameterType="model.Articulo">
        INSERT INTO articulo
        (
            id_categoria,
            id_usuario,
            cantidad,
            descripcion,
            id_color,
            fecha_ingreso,
            precio_compra,
            precio_renta,  
            activo,           
            codigo                     
        )        
        VALUES
        (
            #{categoria.categoriaId},
            #{usuarioId},
            #{cantidad},
            #{descripcion},
            #{color.colorId},
            #{fechaIngreso},
            #{precioCompra},
            #{precioRenta},
            #{activo},
            #{codigo}            
        )
    </insert>
    
    <update id="actualizarArticulo" parameterType="model.Articulo">
        UPDATE articulo
        <set>
            <if test="categoria != null and categoria.categoriaId != null">id_categoria = #{categoria.categoriaId},</if>
            <if test="cantidad != null">cantidad = #{cantidad},</if>
            <if test="descripcion != null">descripcion = #{descripcion},</if>
            <if test="color != null and color.colorId != null">id_color = #{color.colorId},</if>            
            <if test="precioCompra != null">precio_compra = #{precioCompra},</if>
            <if test="precioRenta != null">precio_renta = #{precioRenta},</if>
            <if test="codigo != null">codigo = #{codigo},</if> 
            <if test="activo != null and activo != '' ">activo = #{activo},</if>
            <if test="fechaUltimaModificacion != null ">fecha_ultima_modificacion = #{fechaUltimaModificacion}</if>
        </set>       
        WHERE id_articulo = #{articuloId}
    </update>
    <select id="obtenerColores" resultMap="resultMapColor">
        SELECT * FROM color
    </select>
  
</mapper>