<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="MapperAbonos">
  
    <resultMap id="resultMapAbonos" type="common.model.Abono">        
        <result property="abonoId" column="id_abonos"/>
        <result property="fecha" column="fecha"/>
        <result property="abono" column="abono"/>
        <result property="comentario" column="comentario"/>
        <result property="fechaPago" column="fecha_pago"/>
        
        <!-- tipo abono -->
        <result property="tipoAbono.tipoAbonoId" column="tipo_id"/>
        <result property="tipoAbono.descripcion" column="tipo_descripcion"/>
        <result property="tipoAbono.fgActivo" column="tipo_fg_activo"/>
        <result property="tipoAbono.fechaRegistro" column="tipo_fecha_registro"/>
        
        <!-- cuenta -->
       <result property="tipoAbono.cuenta.id" column="cuenta_id"/>
       <result property="tipoAbono.cuenta.descripcion" column="cuenta_descripcion"/>
       <result property="tipoAbono.cuenta.createdAt" column="cuenta_created_at"/>
       <result property="tipoAbono.cuenta.updatedAt" column="cuenta_updated_at"/>
       <result property="tipoAbono.cuenta.fgActivo" column="cuenta_fg_activo"/>
       
       <!-- usuario -->
       <result property="usuario.usuarioId" column="usuario_id"/>
       <result property="usuario.nombre" column="usuario_nombre"/>
       <result property="usuario.apellidos" column="usuario_apellidos"/>
       
       <!-- renta -->
       <result property="renta.rentaId" column="renta_id"/>
       <result property="renta.folio" column="renta_folio"/>
       <result property="renta.tipo.tipo" column="renta_tipo"/>
       <result property="renta.fechaEvento" column="renta_fecha_evento"/>
       
       <result property="renta.cliente.nombre" column="nombre_cliente"/>
       <result property="renta.cliente.apellidos" column="apellidos_cliente"/>
       
        <result property="totalAbonos" column="suma_abonos"/>
        
        
    </resultMap>
    
    <select id="getByParameters" resultMap="resultMapAbonos" parameterType="java.util.Map">
        SELECT abonos.*,
            tipo.id_tipo_abono AS tipo_id,
            tipo.descripcion AS tipo_descripcion,
            tipo.fg_activo AS tipo_fg_activo,
            tipo.fecha_registro AS tipo_fecha_registro,
            cuenta.id AS cuenta_id,
            cuenta.descripcion AS cuenta_descripcion,
            cuenta.created_at AS cuenta_created_at,
            cuenta.updated_at AS cuenta_updated_at,
            cuenta.fg_activo AS cuenta_fg_activo,
            usuarios.id_usuarios AS usuario_id,
            usuarios.nombre AS usuario_nombre,
            usuarios.apellidos AS usuario_apellidos,
            renta.id_renta AS renta_id,
            renta.folio AS renta_folio,
            renta.fecha_evento AS renta_fecha_evento,
            tipo_renta.tipo AS renta_tipo,
            clientes.nombre AS nombre_cliente,
            clientes.apellidos AS apellidos_cliente
         FROM abonos abonos
            INNER JOIN tipo_abono tipo ON (tipo.id_tipo_abono = abonos.id_tipo_abono)
            INNER JOIN cuenta cuenta ON (cuenta.id = tipo.cuenta_id)
            INNER JOIN usuarios usuarios ON (usuarios.id_usuarios = abonos.id_usuario)
            INNER JOIN renta renta ON (renta.id_renta = abonos.id_renta)
            INNER JOIN clientes clientes ON (renta.id_clientes = clientes.id_clientes)
            INNER JOIN tipo tipo_renta ON (tipo_renta.id_tipo = renta.id_tipo)
            <if test="createdAtInitDate != null and createdAtInitDate != ''
                                and createdAtEndDate != null and createdAtEndDate != ''">
                AND STR_TO_DATE(abonos.fecha,'%d/%m/%Y') BETWEEN STR_TO_DATE (#{createdAtInitDate},'%d/%m/%Y') AND STR_TO_DATE(#{createdAtEndDate},'%d/%m/%Y')
            </if>
            <if test="paymentInitDate != null and paymentInitDate != ''
                                and paymentEndDate != null and paymentEndDate != ''">
                AND STR_TO_DATE(abonos.fecha_pago,'%d/%m/%Y') BETWEEN STR_TO_DATE (#{paymentInitDate},'%d/%m/%Y') AND STR_TO_DATE(#{paymentEndDate},'%d/%m/%Y')
            </if>
            ORDER BY abonos.id_abonos DESC
    </select>
     
     <select id="getAbonosByDates" resultMap="resultMapAbonos" parameterType="java.util.Map">
        SELECT abonos.*,
            tipo.id_tipo_abono AS tipo_id,
            tipo.descripcion AS tipo_descripcion,
            tipo.fg_activo AS tipo_fg_activo,
            tipo.fecha_registro AS tipo_fecha_registro,
            cuenta.id AS cuenta_id,
            cuenta.descripcion AS cuenta_descripcion,
            cuenta.created_at AS cuenta_created_at,
            cuenta.updated_at AS cuenta_updated_at,
            cuenta.fg_activo AS cuenta_fg_activo,
            usuarios.id_usuarios AS usuario_id,
            usuarios.nombre AS usuario_nombre,
            usuarios.apellidos AS usuario_apellidos,
            renta.id_renta AS renta_id,
            renta.folio AS renta_folio,
            tipo_renta.tipo AS renta_tipo
         FROM abonos abonos
            INNER JOIN tipo_abono tipo ON (tipo.id_tipo_abono = abonos.id_tipo_abono)
            INNER JOIN cuenta cuenta ON (cuenta.id = tipo.cuenta_id)
            INNER JOIN usuarios usuarios ON (usuarios.id_usuarios = abonos.id_usuario)
            INNER JOIN renta renta ON (renta.id_renta = abonos.id_renta)
            INNER JOIN tipo tipo_renta ON (tipo_renta.id_tipo = renta.id_tipo)
            WHERE STR_TO_DATE(abonos.fecha_pago,'%d/%m/%Y') 
            BETWEEN STR_TO_DATE (#{initDate},'%d/%m/%Y') AND STR_TO_DATE(#{endDate},'%d/%m/%Y')

    </select>
    
    <select id="getAbonosByDatesGroupByBankAccounts" resultMap="resultMapAbonos" parameterType="java.util.Map">
        SELECT SUM(abonos.abono) AS suma_abonos,
            cuenta.id AS cuenta_id,
            cuenta.descripcion AS cuenta_descripcion,
            cuenta.created_at AS cuenta_created_at,
            cuenta.updated_at AS cuenta_updated_at,
            cuenta.fg_activo AS cuenta_fg_activo
        FROM abonos abonos
            INNER JOIN tipo_abono tipo ON (tipo.id_tipo_abono = abonos.id_tipo_abono)
            INNER JOIN cuenta cuenta ON (cuenta.id = tipo.cuenta_id)
            WHERE STR_TO_DATE(abonos.fecha,'%d/%m/%Y') 
            BETWEEN STR_TO_DATE (#{initDate},'%d/%m/%Y')
            AND STR_TO_DATE(#{endDate},'%d/%m/%Y')
        GROUP BY tipo.cuenta_id
    </select>
  
</mapper>