<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="MapperArticulos">
  
    <resultMap id="resultMapArticulo" type="common.model.Articulo">        
        <result property="articuloId" column="id_articulo"/>
        <result property="categoriaId" column="categoriaId"/>
        <result property="usuarioId" column="id_usuario"/>
        <!-- color -->
        <result property="color.colorId" column="id_color"/>
        <result property="color.color" column="color"/> 
        <result property="color.tono" column="tono"/> 
        <result property="color.comentario" column="comentario"/>      
        
        <result property="cantidad" column="cantidad"/>        
        <result property="descripcion" column="descripcion"/>
        <result property="fechaIngreso" column="fecha_ingreso"/>
        <result property="precioCompra" column="precio_compra"/>
        <result property="precioRenta" column="precio_renta"/>        
        <result property="activo" column="activo"/>
        <result property="stock" column="stock"/>
        <result property="codigo" column="codigo"/>        
        <result property="enRenta" column="en_renta"/>
        <!-- categoria -->
        <result property="categoria.categoriaId" column="id_categoria"/>        
        <result property="categoria.descripcion" column="descripcion_categoria"/>    
        <result property="fechaUltimaModificacion" column="fecha_ultima_modificacion"/>
        
        <result property="rentados" column="rentados" />
        <result property="faltantes" column="faltantes" />
        <result property="reparacion" column="reparacion" />
        <result property="accidenteTrabajo" column="accidente_trabajo" />
        <result property="devolucion" column="devolcion" />
        
        <result property="totalCompras" column="total_compras" />
        <result property="totalShopProvider" column="total_shop_provider" />

    </resultMap>
    
     <resultMap id="resultMapCategoria" type="common.model.CategoriaDTO">        
        <result property="categoriaId" column="id_categoria"/>
        <result property="descripcion" column="descripcion"/> 
    </resultMap>
    
     <resultMap id="resultMapColor" type="common.model.Color">        
        <result property="colorId" column="id_color"/>
        <result property="color" column="color"/> 
         <result property="tono" column="tono"/>
        <result property="comentario" column="comentario"/> 
    </resultMap>
    
    <select id="obtenerArticuloPorId" resultMap="resultMapArticulo" parameterType="java.lang.Integer">
        SELECT articulo.*, 
        categoria.descripcion AS descripcion_categoria, 
        color.color, color.tono, color.comentario       
        FROM articulo articulo
        INNER JOIN categoria categoria ON (categoria.id_categoria = articulo.id_categoria)
        INNER JOIN color color ON (color.id_color = articulo.id_color )
        WHERE articulo.activo = 1   
        AND articulo.id_articulo = #{id}     
    </select> 
    
    <select id="obtenerArticulosActivos" resultMap="resultMapArticulo">
        SELECT articulo.*, 
            categoria.descripcion AS descripcion_categoria, 
            color.color
        FROM articulo articulo
            INNER JOIN categoria categoria ON (categoria.id_categoria = articulo.id_categoria)
            INNER JOIN color color ON (color.id_color = articulo.id_color )
        WHERE articulo.activo = 1
        ORDER BY articulo.descripcion
    </select>  
  
    <select id="obtenerArticulosBusquedaInventario" resultMap="resultMapArticulo" parameterType="java.util.Map">
        SELECT articulo.*, 
            categoria.descripcion AS descripcion_categoria, 
            color.color,
            (
                SELECT
                    SUM(detalle.cantidad) AS cantidad
                FROM renta renta
                    INNER JOIN detalle_renta detalle ON (detalle.id_renta = renta.id_renta)
                WHERE detalle.id_articulo = articulo.id_articulo
                AND renta.id_estado = #{estado_renta}
                AND renta.id_tipo = #{tipo_pedido}
            ) AS rentados,
            (
                SELECT 
                    SUM(faltante.cantidad)
                FROM faltantes faltante    
                WHERE faltante.id_articulo = articulo.id_articulo
                AND faltante.fg_faltante = '1'
                AND faltante.fg_devolucion = '0'
                AND faltante.fg_accidente_trabajo = '0'
                AND faltante.fg_activo = '1'
            ) AS faltantes,
            (
                SELECT 
                    SUM(faltante.cantidad)
                FROM faltantes faltante              
                WHERE faltante.id_articulo = articulo.id_articulo
                AND faltante.fg_faltante = '0'
                AND faltante.fg_devolucion = '0'
                AND faltante.fg_accidente_trabajo = '0'
                AND faltante.fg_activo = '1'
            ) AS reparacion,
            (
                SELECT 
                    SUM(faltante.cantidad)
                FROM faltantes faltante              
                WHERE faltante.id_articulo = articulo.id_articulo
                AND faltante.fg_faltante = '0'
                AND faltante.fg_devolucion = '0'
                AND faltante.fg_accidente_trabajo = '1'
                AND faltante.fg_activo = '1'
            ) AS accidente_trabajo,
            (
                SELECT
                    SUM(faltante.cantidad)
                FROM faltantes faltante         
                WHERE faltante.id_articulo = articulo.id_articulo
                AND faltante.fg_devolucion = '1'
                AND faltante.fg_faltante = '0'
                AND faltante.fg_activo = '1'
            ) AS devolucion,
            (
                SELECT
                    SUM(compras.cantidad)
                FROM compras compras
                WHERE compras.id_articulo = articulo.id_articulo
                AND compras.fg_activo = '1' 
            ) AS total_compras,
            (
                SELECT 
                    SUM(detalle_orden_proveedor.cantidad)
                FROM detalle_orden_proveedor detalle_orden_proveedor
                    INNER JOIN orden_proveedor orden_proveedor ON (orden_proveedor.id = detalle_orden_proveedor.id_orden_proveedor)
                WHERE detalle_orden_proveedor.fg_activo = '1'
                AND detalle_orden_proveedor.id_articulo = articulo.id_articulo
                AND orden_proveedor.status = #{statusOrder} OR orden_proveedor.status = #{statusOrderFinish}
                AND detalle_orden_proveedor.tipo_orden_detalle_proveedor_id = #{typeOrderDetail}
            ) AS total_shop_provider
        FROM articulo articulo
            INNER JOIN categoria categoria ON (categoria.id_categoria = articulo.id_categoria)
            INNER JOIN color color ON (color.id_color = articulo.id_color )
        WHERE articulo.activo = 1
        <if test="categoria != null and categoria.categoriaId != 0 ">
            AND categoria.id_categoria = #{categoria.categoriaId}
        </if>
        <if test="color != null and color.colorId != 0 ">
            AND color.id_color = #{color.colorId}
        </if>
        <if test="descripcion != null and descripcion != '' ">
            AND articulo.descripcion LIKE CONCAT('%',#{descripcion},'%')
        </if>
    </select>  
    
    <select id="obtenerEnRenta" parameterType="java.util.Map" resultType="java.lang.String">
        SELECT SUM(detalle.cantidad)AS cantidad
        FROM renta renta
        INNER JOIN detalle_renta detalle ON (detalle.id_renta = renta.id_renta)
        WHERE detalle.id_articulo = #{articuloId}
        AND renta.id_estado = #{estado_renta}
        AND renta.id_tipo = #{tipo_pedido}
    </select>
    
    <select id="obtenerFaltantes" parameterType="java.util.Map" resultType="java.lang.String">
        SELECT SUM(faltante.cantidad)AS cantidad
        FROM faltantes faltante    
        WHERE faltante.id_articulo = #{articuloId} 
        AND faltante.fg_faltante = '1'
        AND faltante.fg_devolucion = '0'
        AND faltante.fg_accidente_trabajo = '0'
        AND faltante.fg_activo = '1'
    </select>
    
    <select id="obtenerReparacion" parameterType="java.util.Map" resultType="java.lang.String">
        SELECT SUM(faltante.cantidad)AS cantidad
        FROM faltantes faltante              
        WHERE faltante.id_articulo = #{articuloId}  
        AND faltante.fg_faltante = '0'
        AND faltante.fg_devolucion = '0'
        AND faltante.fg_accidente_trabajo = '0'
        AND faltante.fg_activo = '1'
    </select>
    
    <select id="obtenerAccidenteTrabajo" parameterType="java.util.Map" resultType="java.lang.String">
        SELECT SUM(faltante.cantidad)AS cantidad
        FROM faltantes faltante              
        WHERE faltante.id_articulo = #{articuloId}   
        AND faltante.fg_faltante = '0'
        AND faltante.fg_devolucion = '0'
        AND faltante.fg_accidente_trabajo = '1'
        AND faltante.fg_activo = '1'
    </select>
    
     <select id="obtenerDevolucion" parameterType="java.util.Map" resultType="java.lang.String">
        SELECT SUM(faltante.cantidad)AS cantidad
        FROM faltantes faltante         
        WHERE faltante.id_articulo = #{articuloId}
        AND faltante.fg_devolucion = '1'
        AND faltante.fg_faltante = '0'
        AND faltante.fg_activo = '1'
    </select>
    
    <select id="obtenerCategoriaPorDescripcion" parameterType="java.lang.String" resultMap="resultMapCategoria">
        SELECT * 
        FROM categoria 
        WHERE descripcion = #{descripcion}        
    </select>
    
    <select id="obtenerColorPorDescripcion" parameterType="java.lang.String" resultMap="resultMapColor">
        SELECT * 
        FROM color 
        WHERE color = #{descripcion}        
    </select>
    <insert id="insertarArticulo" parameterType="common.model.Articulo">
        INSERT INTO articulo
        (
            id_categoria,
            id_usuario,
            cantidad,
            descripcion,
            id_color,
            fecha_ingreso,
            precio_compra,
            precio_renta,  
            activo,           
            codigo                     
        )        
        VALUES
        (
            #{categoria.categoriaId},
            #{usuarioId},
            #{cantidad},
            #{descripcion},
            #{color.colorId},
            #{fechaIngreso},
            #{precioCompra},
            #{precioRenta},
            #{activo},
            #{codigo}            
        )
    </insert>
    
    <update id="actualizarArticulo" parameterType="common.model.Articulo">
        UPDATE articulo
        <set>
            <if test="categoria != null and categoria.categoriaId != null">id_categoria = #{categoria.categoriaId},</if>
            <if test="cantidad != null">cantidad = #{cantidad},</if>
            <if test="descripcion != null">descripcion = #{descripcion},</if>
            <if test="color != null and color.colorId != null">id_color = #{color.colorId},</if>            
            <if test="precioCompra != null">precio_compra = #{precioCompra},</if>
            <if test="precioRenta != null">precio_renta = #{precioRenta},</if>
            <if test="codigo != null">codigo = #{codigo},</if> 
            <if test="activo != null and activo != '' ">activo = #{activo},</if>
            <if test="fechaUltimaModificacion != null ">fecha_ultima_modificacion = #{fechaUltimaModificacion}</if>
        </set>       
        WHERE id_articulo = #{articuloId}
    </update>
    <select id="obtenerColores" resultMap="resultMapColor">
        SELECT * FROM color ORDER BY color
    </select>
  
</mapper>